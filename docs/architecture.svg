<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="820" viewBox="0 0 1200 820">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#333"/>
    </marker>
    <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.2"/>
    </filter>
  </defs>
<text x="40" y="50" font-family="Inter, Arial, sans-serif" font-size="28" font-weight="bold" text-anchor="start">JWT Auth in a Todo API — System Diagram (No Caching)</text><rect x="920" y="70" width="240" height="105" rx="14" ry="14" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1.5"/><text x="940" y="95" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Legend</text><rect x="940" y="110" width="14" height="14" rx="4" ry="4" fill="#eef2ff" stroke="#6366f1" stroke-width="1.5"/><text x="962" y="122" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">Compute / Service</text><rect x="940" y="135" width="14" height="14" rx="4" ry="4" fill="#fff7ed" stroke="#f59e0b" stroke-width="1.5"/><text x="962" y="147" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">Database / Persistent Store</text><rect x="940" y="160" width="14" height="14" rx="4" ry="4" fill="#ecfdf5" stroke="#10b981" stroke-width="1.5"/><text x="962" y="172" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">Keys / Crypto Material</text><rect x="40" y="90" width="280" height="120" rx="18" ry="18" fill="#eef2ff" stroke="#6366f1" stroke-width="2"/><text x="60" y="120" font-family="Inter, Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="start">Client (Web/Mobile)</text><text x="60" y="145" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="normal" text-anchor="start">Sends HTTP requests</text><text x="60" y="165" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="normal" text-anchor="start">Authorization: Bearer &lt;access_jwt&gt;</text><text x="60" y="185" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="normal" text-anchor="start">Calls: /auth/*, /todos*</text><rect x="360" y="90" width="500" height="620" rx="22" ry="22" fill="#eef2ff" stroke="#6366f1" stroke-width="2"/><text x="380" y="120" font-family="Inter, Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="start">API Server</text><text x="380" y="142" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">(e.g., FastAPI/Express)</text><rect x="380" y="170" width="460" height="120" rx="16" ry="16" fill="#ffffff" stroke="#94a3b8" stroke-width="1.5"/><text x="400" y="195" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Auth Middleware</text><text x="400" y="218" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">• Extract Authorization: Bearer &lt;access_jwt&gt;</text><text x="400" y="238" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">• Verify JWT signature (HS256 or RS/ES)</text><text x="400" y="258" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">• Validate iss, aud, exp, nbf, jti</text><text x="400" y="278" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">• Attach user_id, scopes to request context</text><rect x="380" y="320" width="460" height="160" rx="16" ry="16" fill="#ffffff" stroke="#94a3b8" stroke-width="1.5"/><text x="400" y="345" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Todo Handlers</text><text x="400" y="368" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">Endpoints:</text><text x="400" y="388" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">POST /todos — create_todo(user_id, title, ...)</text><text x="400" y="408" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">GET /todos — list_todos(user_id)</text><text x="400" y="428" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">PATCH /todos/{id} — update_todo(user_id, ...)</text><text x="400" y="448" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">DELETE /todos/{id} — delete_todo(user_id)</text><rect x="380" y="510" width="460" height="160" rx="16" ry="16" fill="#ffffff" stroke="#94a3b8" stroke-width="1.5"/><text x="400" y="535" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Auth Controllers</text><text x="400" y="558" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">POST /auth/register  → register_user(email, password_hash)</text><text x="400" y="578" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">POST /auth/login     → login() → issue_tokens(user_id)</text><text x="400" y="598" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">POST /auth/refresh   → rotate_refresh_token(old) → issue_tokens()</text><text x="400" y="618" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">POST /auth/logout    → revoke_refresh(refresh_token_id)</text><rect x="920" y="260" width="240" height="120" rx="18" ry="18" fill="#fff7ed" stroke="#f59e0b" stroke-width="2"/><text x="940" y="285" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Todo DB</text><text x="940" y="308" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">todos(id, owner_id, title, completed,</text><text x="940" y="328" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">      created_at, updated_at, …)</text><rect x="920" y="430" width="240" height="180" rx="18" ry="18" fill="#fff7ed" stroke="#f59e0b" stroke-width="2"/><text x="940" y="455" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Auth DB</text><text x="940" y="478" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">users(id, email, password_hash, status, …)</text><text x="940" y="498" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">refresh_tokens(id, user_id, token_hash,</text><text x="940" y="518" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">               expires_at, rotated_from_id, revoked_at)</text><text x="940" y="538" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">jwt_revocations(jti, revoked_at)  (optional)</text><text x="940" y="558" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">roles(id, name), user_roles(user_id, role_id)  (optional)</text><rect x="40" y="260" width="280" height="180" rx="18" ry="18" fill="#ecfdf5" stroke="#10b981" stroke-width="2"/><text x="60" y="285" font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="start">Key Material</text><text x="60" y="308" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">HS256: shared secret for signing + verifying</text><text x="60" y="328" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">RS/ES: private key (issuer), public JWK (verifier)</text><text x="60" y="348" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">• Used by Auth Controllers to sign access_jwt</text><text x="60" y="368" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">• Used by Middleware to verify signature</text><line x1="320" y1="150" x2="360" y2="150" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/><text x="322" y="142" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">/auth/*, /todos*</text><line x1="840" y1="375" x2="920" y2="320" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/><text x="845" y="330" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">read/write</text><line x1="840" y1="590" x2="920" y2="520" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/><text x="845" y="545" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">read/write</text><path d="M 320 330 C 350 330, 350 600, 380 600" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrow)"/><text x="240" y="338" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">sign tokens</text><path d="M 320 330 C 360 330, 360 230, 380 230" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrow)"/><text x="240" y="250" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">verify tokens</text><line x1="320" y1="120" x2="360" y2="120" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/><text x="332" y="112" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">HTTP</text><line x1="520" y1="170" x2="520" y2="160" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/><line x1="610" y1="290" x2="610" y2="320" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/><text x="620" y="305" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">on success</text><path d="M 320 120 C 340 120, 340 560, 380 560" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrow)"/><text x="322" y="540" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="normal" text-anchor="start">/auth/*</text><text x="60" y="520" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">Typical flow:</text><text x="60" y="540" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">1) POST /auth/login  → {access_jwt, refresh_token}</text><text x="60" y="560" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">2) GET /todos with Authorization: Bearer &lt;access_jwt&gt;</text><text x="60" y="580" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">3) Middleware verifies JWT, attaches user_id</text><text x="60" y="600" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">4) Handlers scope queries by owner_id=user_id</text><text x="60" y="620" font-family="Inter, Arial, sans-serif" font-size="13" font-weight="normal" text-anchor="start">5) POST /auth/refresh to rotate refresh token</text><rect x="20" y="70" width="1160" height="700" rx="24" ry="24" fill="none" stroke="#e5e7eb" stroke-width="1"/></svg>